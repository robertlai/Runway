// Generated by CoffeeScript 1.9.3
var app, scrollAtBottom, scrollToBottom, updateScrollState;

app = angular.module('workspaceApp', []);

scrollAtBottom = true;

app.controller('workspaceController', function($scope) {});

app.controller('messagesController', function($scope, $http, $interval) {
  var fetchInitialMessages, fetchNewMessages, lastMessageId;
  $scope.chatVisible = true;
  $scope.newCommentNotValide = false;
  lastMessageId = -1;
  $scope.messages = [];
  fetchNewMessages = function() {
    return $http.get('/api/message?lastMessageId=' + lastMessageId).success(function(message) {
      lastMessageId = message.timestamp;
      return $scope.messages.push(message);
    });
  };
  $scope.hideChat = function() {
    $scope.chatVisible = false;
    return document.getElementById('dropzone').style.width = '100%';
  };
  $scope.showChat = function() {
    $scope.chatVisible = true;
    return document.getElementById('dropzone').style.width = '75%';
  };
  $scope.addComment = function() {
    if ($scope.newComment.trim().length > 0) {
      $scope.newCommentNotValide = false;
      return $http.post('/api/message?user=' + $scope.username + '&content=' + $scope.newComment).then(function() {
        return $scope.newComment = '';
      });
    }
  };
  $scope.removeComment = function(timestamp) {
    return $http["delete"]('/api/message?timestamp=' + timestamp).then(function() {
      var i, j, len, message, ref;
      i = 0;
      ref = $scope.messages;
      for (j = 0, len = ref.length; j < len; j++) {
        message = ref[j];
        if (message.timestamp === timestamp) {
          $scope.messages.splice(i, 1);
          break;
        }
        i++;
      }
    });
  };
  fetchInitialMessages = function() {
    return $http.get('/api/messages').success(function(messages) {
      var j, len, message;
      for (j = 0, len = messages.length; j < len; j++) {
        message = messages[j];
        if (message.timestamp > lastMessageId) {
          lastMessageId = message.timestamp;
        }
      }
      return $scope.messages = messages;
    });
  };
  return fetchInitialMessages().then(function() {
    return $interval(fetchNewMessages, 500);
  });
});

window.onload = function() {
  var i, msgpanel;
  msgpanel = document.getElementById("msgpanel");
  msgpanel.scrollTop = msgpanel.scrollHeight;
  return i = setInterval(scrollToBottom, 100);
};

updateScrollState = function() {
  return scrollAtBottom = msgpanel.scrollTop === (msgpanel.scrollHeight - msgpanel.offsetHeight);
};

scrollToBottom = function() {
  if (scrollAtBottom) {
    return msgpanel.scrollTop = msgpanel.scrollHeight;
  }
};

// Generated by CoffeeScript 1.9.3
var User, isLoggedIn,
  indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

User = require('../models/User');

isLoggedIn = function(req, res, next) {
  if (req.isAuthenticated()) {
    return next();
  } else {
    return res.redirect('/login');
  }
};

module.exports = function(app, passport) {
  app.get('/login', function(req, res) {
    return res.render('login', {
      title: 'Login',
      message: req.flash('loginMessage')
    });
  });
  app.post('/login', passport.authenticate('login', {
    successRedirect: '/home',
    failureRedirect: '/login',
    failureFlash: true
  }));
  app.get('/register', function(req, res) {
    return res.render('login', {
      title: 'Register',
      message: req.flash('registerMessage')
    });
  });
  app.post('/register', passport.authenticate('register', {
    successRedirect: '/login',
    failureRedirect: '/register',
    failureFlash: true
  }));
  app.get('/home', isLoggedIn, function(req, res) {
    return res.render('home', {
      title: 'Home',
      username: req.user.username
    });
  });
  app.get('/workspace', isLoggedIn, function(req, res) {
    var groupRequested, username;
    username = req.user.username;
    groupRequested = req.query.group;
    return User.findOne({
      username: username
    }).select('groups').exec(function(err, user) {
      if (err) {
        return res.sendStatus(500);
      } else {
        if (indexOf.call(user.groups, groupRequested) >= 0) {
          return res.render('workspace', {
            title: 'Workspace: ' + groupRequested,
            username: username,
            groupName: groupRequested
          });
        } else {
          return res.render('error', {
            title: 'Error',
            message: 'Unauthorized.  You do not have access to this group.',
            error: {
              status: 401
            }
          });
        }
      }
    });
  });
  return app.get('*', isLoggedIn, function(req, res) {
    return res.redirect('/home');
  });
};
